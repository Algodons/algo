name: PR Notifications

on:
  pull_request:
    types: [opened, reopened, ready_for_review, review_requested]
  pull_request_review:
    types: [submitted]

jobs:
  notify-reviewers:
    name: Notify Reviewers
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Send notification for new PR
        if: |
          github.event.action == 'opened' || 
          github.event.action == 'reopened' ||
          github.event.action == 'ready_for_review'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const isDraft = pr.draft;
            
            if (isDraft) {
              console.log('PR is draft, skipping notification');
              return;
            }
            
            const message = `
            ðŸ“¢ **New Pull Request Ready for Review**
            
            **Title:** ${pr.title}
            **Author:** @${pr.user.login}
            **Branch:** \`${pr.head.ref}\` â†’ \`${pr.base.ref}\`
            
            Please review when you have a chance! ðŸš€
            `;
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: message
            });

      - name: Notify on review submission
        if: github.event.action == 'submitted'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = context.payload.review;
            const pr = context.payload.pull_request;
            
            let emoji = 'ðŸ’¬';
            if (review.state === 'approved') {
              emoji = 'âœ…';
            } else if (review.state === 'changes_requested') {
              emoji = 'ðŸ”„';
            }
            
            console.log(`Review ${review.state} submitted by ${review.user.login}`);
            
            // Notify PR author
            const message = `
            ${emoji} **Review Update**
            
            @${review.user.login} has submitted a review: **${review.state.replace('_', ' ')}**
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: message
            });

  label-pr:
    name: Auto-Label PR
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'reopened'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label PR based on files changed
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // Get list of files changed
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const labels = new Set();
            
            for (const file of files) {
              const path = file.filename;
              
              // Frontend changes
              if (path.startsWith('src/') || path.includes('.tsx') || path.includes('.jsx')) {
                labels.add('frontend');
              }
              
              // Backend changes
              if (path.startsWith('server/') || path.includes('server')) {
                labels.add('backend');
              }
              
              // Test changes
              if (path.includes('.test.') || path.includes('.spec.') || path.includes('__tests__')) {
                labels.add('tests');
              }
              
              // Documentation changes
              if (path.endsWith('.md') || path.includes('docs/')) {
                labels.add('documentation');
              }
              
              // Configuration changes
              if (path.includes('.json') || path.includes('.yml') || path.includes('.yaml') || path.includes('config')) {
                labels.add('configuration');
              }
              
              // Workflow changes
              if (path.includes('.github/workflows/')) {
                labels.add('ci/cd');
              }
            }
            
            // Add size label based on lines changed
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            
            if (totalChanges < 10) {
              labels.add('size/xs');
            } else if (totalChanges < 50) {
              labels.add('size/s');
            } else if (totalChanges < 200) {
              labels.add('size/m');
            } else if (totalChanges < 500) {
              labels.add('size/l');
            } else {
              labels.add('size/xl');
            }
            
            // Apply labels
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: Array.from(labels)
              });
              
              console.log(`Added labels: ${Array.from(labels).join(', ')}`);
            }
